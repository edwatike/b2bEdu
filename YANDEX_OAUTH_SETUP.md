# üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ø–Ω–¥–µ–∫—Å OAuth –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É

## –°–ø–æ—Å–æ–±—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

–í —Å–∏—Å—Ç–µ–º–µ –¥–æ—Å—Ç—É–ø–Ω–æ **–¥–≤–∞ —Å–ø–æ—Å–æ–±–∞** –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

1. **–û–±—ã—á–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
2. **–í—Ö–æ–¥ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å** - —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è (–±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OAuth)

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ –ª–æ–≥–∏–Ω—É/–ø–∞—Ä–æ–ª—é:

1. **–û—Å—Ç–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ø–Ω–¥–µ–∫—Å OAuth –ø—É—Å—Ç—ã–º–∏** –≤ `.env.local`:
```env
YANDEX_CLIENT_ID=
YANDEX_CLIENT_SECRET=
```

2. **–ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–æ–µ—Ç—Å—è** –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—Ö–æ–¥–∞

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ–º–æ-–¥–æ—Å—Ç—É–ø** –¥–ª—è –≤—Ö–æ–¥–∞:
   - –õ–æ–≥–∏–Ω: `admin`
   - –ü–∞—Ä–æ–ª—å: `admin123`

## –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å OAuth

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å ID:

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –Ø–Ω–¥–µ–∫—Å

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ **https://oauth.yandex.ru/**
2. –í–æ–π–¥–∏—Ç–µ —Å –≤–∞—à–∏–º –Ø–Ω–¥–µ–∫—Å –∞–∫–∫–∞—É–Ω—Ç–æ–º
3. –ù–∞–∂–º–∏—Ç–µ **"–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**: B2B Moderator Dashboard
   - **–û–ø–∏—Å–∞–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏
   - **–ò–∫–æ–Ω–∫–∞**: –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ª—é–±–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Callback URL

–í —Ä–∞–∑–¥–µ–ª–µ **"–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã"** –≤—ã–±–µ—Ä–∏—Ç–µ **"–í–µ–±-—Å–µ—Ä–≤–∏—Å—ã"** –∏ —É–∫–∞–∂–∏—Ç–µ:

```
https://hobnailed-ballistically-jolie.ngrok-free.dev/api/yandex/callback
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ –≤–∞—à ngrok URL –∏–∑–º–µ–Ω–∏—Ç—Å—è, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å!

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤—å—Ç–µ:
```
http://localhost:3000/api/yandex/callback
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

–í —Ä–∞–∑–¥–µ–ª–µ **"–î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º"** –≤—ã–±–µ—Ä–∏—Ç–µ:

- ‚úÖ **–Ø–Ω–¥–µ–∫—Å.–ü–∞—Å–ø–æ—Ä—Ç** ‚Üí `login:email` (–î–æ—Å—Ç—É–ø –∫ –∞–¥—Ä–µ—Å—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã)
- ‚úÖ **–Ø–Ω–¥–µ–∫—Å.–ü–∞—Å–ø–æ—Ä—Ç** ‚Üí `login:info` (–î–æ—Å—Ç—É–ø –∫ –∏–º–µ–Ω–∏, —Ñ–∞–º–∏–ª–∏–∏ –∏ –ø–æ–ª—É)

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—á—Ç–æ–π:
- ‚úÖ **–Ø–Ω–¥–µ–∫—Å.–ü–æ—á—Ç–∞** ‚Üí `mail:read` (–ß—Ç–µ–Ω–∏–µ –ø–∏—Å–µ–º)
- ‚úÖ **–Ø–Ω–¥–µ–∫—Å.–ü–æ—á—Ç–∞** ‚Üí `mail:send` (–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º)

### –®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:

- **ClientID** (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
- **Client Secret** (—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á)

### –®–∞–≥ 5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ .env.local

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `.env.local` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
# Yandex OAuth Configuration
YANDEX_CLIENT_ID=–≤–∞—à_client_id_–∑–¥–µ—Å—å
YANDEX_CLIENT_SECRET=–≤–∞—à_client_secret_–∑–¥–µ—Å—å
YANDEX_REDIRECT_URI=https://hobnailed-ballistically-jolie.ngrok-free.dev/api/yandex/callback
YANDEX_SCOPE=login:email login:info

# Moderator Master Email (—ç—Ç–æ—Ç email –ø–æ–ª—É—á–∏—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
MODERATOR_MASTER_EMAIL=edwatik@yandex.ru
```

‚ö†Ô∏è **–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:**
- –ó–∞–º–µ–Ω–∏—Ç–µ `MODERATOR_MASTER_EMAIL` –Ω–∞ –≤–∞—à email, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —ç—Ç–∏–º email –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤ —Ä–∞–∑–¥–µ–ª `/moderator`
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ø–∞–¥—É—Ç –≤ —Ä–∞–∑–¥–µ–ª `/cabinet`

### –®–∞–≥ 6: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.env.local` –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Next.js:

```bash
npm run dev
# –∏–ª–∏
pnpm dev
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É `/login`
2. –í—ã —É–≤–∏–¥–∏—Ç–µ –¥–≤–µ –æ–ø—Ü–∏–∏:
   - **–§–æ—Ä–º–∞ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è** (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞)
   - **–ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å"** (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω OAuth)
3. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å"
4. –í–∞—Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ø–Ω–¥–µ–∫—Å–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
5. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã –≤–µ—Ä–Ω–µ—Ç–µ—Å—å –≤ —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º

## üìä –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–∏ –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å:

1. **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–∫–∫–∞—É–Ω—Ç –≤ –ë–î
2. **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `last_login` –∏ OAuth —Ç–æ–∫–µ–Ω—ã
3. **–ú–∞—Å—Ç–µ—Ä-–º–æ–¥–µ—Ä–∞—Ç–æ—Ä** (email = MODERATOR_MASTER_EMAIL): –ø–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª—å `moderator` –∏ –¥–æ—Å—Ç—É–ø –∫ `/moderator`
4. **–û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –ø–æ–ª—É—á–∞—é—Ç —Ä–æ–ª—å `user` –∏ –¥–æ—Å—Ç—É–ø –∫ `/cabinet`

### –°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:

- `email` - –ø–æ—á—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `yandex_access_token` - —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API –Ø–Ω–¥–µ–∫—Å–∞
- `yandex_refresh_token` - —Ç–æ–∫–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
- `yandex_token_expires_at` - –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- `auth_method` - —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞ (`yandex_oauth`)
- `cabinet_access_enabled` - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≤—Ö–æ–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `httpOnly` cookies
- ‚úÖ OAuth state –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF
- ‚úÖ –í—Å–µ —Ç–æ–∫–µ–Ω—ã —à–∏—Ñ—Ä—É—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTTPS –¥–ª—è production
- ‚úÖ Cookies —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ä–µ–∂–∏–º–µ `sameSite: lax`

## ‚ùó –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### "YANDEX_CLIENT_ID is not configured"

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `YANDEX_CLIENT_ID` –∏ `YANDEX_CLIENT_SECRET` –≤ `.env.local` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å.

### "Invalid redirect_uri"

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `YANDEX_REDIRECT_URI` –≤ `.env.local` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ —É–∫–∞–∑–∞–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ oauth.yandex.ru.

### "Invalid state"

**–†–µ—à–µ–Ω–∏–µ:** –û—á–∏—Å—Ç–∏—Ç–µ cookies –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞. –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF-–∞—Ç–∞–∫.

### –ö–Ω–æ–ø–∫–∞ –Ø–Ω–¥–µ–∫—Å–∞ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ `YANDEX_CLIENT_ID` –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å.

## üìù –ò—Ç–æ–≥–æ

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã OAuth **–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω**. –í—ã –º–æ–∂–µ—Ç–µ:

- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å (–¥–µ–º–æ: `admin` / `admin123`)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å OAuth –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ —Å–ø–æ—Å–æ–±–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

---

**–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö.
