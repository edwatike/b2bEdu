> Этот документ описывает целевое поведение системы.
> Если текущая реализация отличается — это считается дефектом.

# Введение
Система нужна, чтобы быстро находить поставщиков по нужным товарам, проверять их и помогать пользователю отправлять им запросы.

Для кого:
- для модератора (управляет процессом)
- для пользователя личного кабинета (создает заявки и получает результаты)

Какую задачу решает:
- вместо ручного поиска и проверки поставщиков система делает это автоматически и показывает понятные статусы.

# Глоссарий
- Заявка: запрос пользователя на поиск поставщиков.
- Позиция заявки: отдельный товар/услуга внутри заявки.
- Запуск парсинга: отдельный запуск поиска сайтов по одному ключу.
- Домен: сайт, который нашли в поиске.
- Обогащение: попытка найти по сайту ИНН и email.
- Поставщик: компания в базе.
- Реселлер: компания-посредник в базе.
- Черный список (blacklist): список сайтов, которые нельзя использовать.
- Требуется модерация: система не смогла автоматически найти нужные данные по домену.
- Checko: внешний сервис, откуда берутся данные компании по ИНН.

# Инварианты системы
Это правила, которые нельзя нарушать:
- Один ИНН не должен появляться у разных компаний (если не включено специальное разрешение).
- Сайт из черного списка не должен быть в рабочих списках.
- Пользователь ЛК не должен видеть служебные разделы модератора.
- Если по компании получены полные данные из Checko, статус данных должен быть "получены".
- Если ИНН и email не найдены, домен должен быть помечен "Требуется модерация".

# Роли и доступы

## Модератор
### A. Как это выглядит для пользователя
Модератор видит дашборд, запуски, домены, поставщиков, черный список и пользователей.

### B. Что система разрешает и запрещает
Разрешает управлять всей операционной частью.
Запрещает только то, что выходит за рамки прав доступа.

### C. Как реализовано сейчас
Рабочие страницы и действия модератора доступны и используются в ежедневной работе.

### D. Как должно работать
Все статусы, цифры и действия должны быть прозрачны и совпадать с фактом.

## Пользователь ЛК
### A. Как это выглядит для пользователя
Пользователь создает заявку, отслеживает результат и отправляет сообщения поставщикам.

### B. Что система разрешает и запрещает
Разрешает работать только со своими заявками.
Запрещает доступ к модераторским разделам.

### C. Как реализовано сейчас
Основной сценарий работает: создание заявки, просмотр результата, сообщения.

### D. Как должно работать
Пользователь должен видеть только свои данные и понятный прогресс обработки.

# Основные процессы системы

## Процесс: Создание заявки
### A. Как это видит пользователь
Пользователь создает заявку и отправляет ее в работу.

### B. Что система делает
Сохраняет заявку и запускает поиск поставщиков по позициям.

### C. Где это видно
- ЛК: создание заявки
- ЛК: список заявок
- ЛК: карточка заявки

### D. Как реализовано технически
Работа идет через сервер и фоновые процессы.

### E. Как работает СЕЙЧАС
Работает в основном стабильно.

### F. Как ДОЛЖНО работать
После отправки заявки пользователь должен видеть понятный путь: "принята → в обработке → результат готов".

### G. Ограничения и риски
Поиск может занимать время, особенно при большой нагрузке.

### H. Точки роста
Добавить более подробный прогресс по этапам.

### I. Проверяемые утверждения
- ЕСЛИ заявка отправлена, СИСТЕМА ОБЯЗАНА начать обработку.

## Процесс: Запуск парсинга
### A. Как это видит пользователь
Модератор запускает поиск по ключевому слову.

### B. Что система делает
Ищет сайты, сохраняет найденные домены.

### C. Где это видно
- Дашборд модератора
- Список запусков
- Карточка запуска

### D. Как реализовано технически
Работает как фоновый процесс с проверкой здоровья сервисов.

### E. Как работает СЕЙЧАС
Запуски создаются и отображаются. Технические детали (по коду на 07.02.2026):
- **Оптимизация загрузки:** endpoint `GET /parsing-runs/runs` в `parsing_runs.py` использует **batch-запрос** `SELECT parsing_run_id, COUNT(*) FROM domains_queue WHERE parsing_run_id = ANY(:ids) GROUP BY parsing_run_id` вместо N+1 запросов. Один SQL вместо 100.
- **Keyword extraction:** для каждого рана извлекается keyword из `process_log.keyword` → `request.raw_keys_json` → `request.title` (в порядке приоритета).

### F. Как ДОЛЖНО работать
Статусы и счетчики должны быть точными, без "зависло" или "готово" не по факту.

### G. Ограничения и риски
Зависимость от внешних сайтов и скорости поиска.

### H. Точки роста
Усилить контроль очередей и перезапусков.

### I. Проверяемые утверждения
- ЕСЛИ запуск создан, СИСТЕМА ОБЯЗАНА показать его в списке запусков.

## Процесс: Обогащение доменов (ИНН + email)
### A. Как это видит пользователь
Модератор нажимает "Получить данные" и видит прогресс.

### B. Что система делает
Для каждого выбранного домена пытается найти ИНН и email.

### C. Где это видно
- Карточка запуска
- Домены в очереди

### D. Как реализовано технически
Пакетная обработка в фоне.

### E. Как работает СЕЙЧАС
Работает. Технические детали (по коду на 07.02.2026):
- **Фильтрация доменов:** `_domain_exists_in_suppliers()` и `_domain_requires_moderation()` в `domain_parser.py` проверяют **оба** варианта домена — полный (`spb.lemanapro.ru`) и корневой (`lemanapro.ru`). Если хотя бы один найден в `moderator_suppliers`/`supplier_domains` или `domain_moderation` — домен пропускается.
- **Нормализация:** `_normalize_domain_full()` — lowercase + убрать www/протокол/путь (субдомены сохраняются). `_normalize_domain()` → `normalize_domain_root()` — обрезает до корневого домена.
- **Extraction log:** парсер (`parser.py`, метод `parse_domain`) сохраняет `extraction_log` — список посещённых страниц с результатами: `{url, inn_found, emails_found, error}`.
- **Recovery при старте:** `main.py` сбрасывает `running` → `queued` (Recovery A) и переставляет в очередь `completed`/`failed` раны с необработанными доменами (Recovery B). Recovery B выполняется **только при старте**, не в основном цикле.

### F. Как ДОЛЖНО работать
После обработки домен должен иметь понятный итог:
- поставщик/реселлер
- требуется модерация
- исключен (черный список)

### G. Ограничения и риски
Не на всех сайтах можно автоматически найти нужные данные.

### H. Точки роста
Сделать еще прозрачнее лог шагов и причины отказа.

### I. Проверяемые утверждения
- ЕСЛИ ИНН+email найдены, СИСТЕМА ОБЯЗАНА создать/обновить компанию.
- ЕСЛИ не найдены, СИСТЕМА ОБЯЗАНА поставить "Требуется модерация".

## Процесс: Получение данных компании из Checko
### A. Как это видит пользователь
После запроса система подтягивает реквизиты компании.

### B. Что система делает
По ИНН получает данные и сохраняет их в карточке компании.

### C. Где это видно
- Страница запусков (метка CHECKO)
- Страница поставщиков
- Карточка поставщика

### D. Как реализовано технически
Используются API-ключи, есть ротация ключей при ограничениях.

### E. Как работает СЕЙЧАС
Настроена ротация 3 ключей, данные сохраняются.

### F. Как ДОЛЖНО работать
После успешного ответа статус данных должен сразу становиться "получены".

### G. Ограничения и риски
Ограничения внешнего сервиса и временные ошибки сети.

### H. Точки роста
Сделать массовое получение данных на стороне сервера, а не только через страницу.

### I. Проверяемые утверждения
- ЕСЛИ Checko вернул данные, СИСТЕМА ОБЯЗАНА сохранить их и обновить статус.

## Процесс: Черный список
### A. Как это видит пользователь
Модератор добавляет домен в черный список.

### B. Что система делает
Исключает этот домен из рабочих списков.

### C. Где это видно
- Страница черного списка
- Страница запусков
- Домены в очереди

### D. Как реализовано технически
Есть добавление, удаление и фильтрация.

### E. Как работает СЕЙЧАС
Основной сценарий работает.

### F. Как ДОЛЖНО работать
После добавления домен должен исчезать сразу.

### G. Ограничения и риски
Возможен временный рассинхрон интерфейса при кэшировании.

### H. Точки роста
Усилить мгновенное обновление списков без перезагрузки.

### I. Проверяемые утверждения
- ЕСЛИ домен в черном списке, СИСТЕМА ОБЯЗАНА убрать его из рабочих экранов.

# Страницы системы

## Страница: Дашборд модератора
URL: `/moderator`

### Цель страницы
Быстрый запуск поиска и контроль состояния системы.

### Связанные процессы
Запуск парсинга, мониторинг запусков и очередей.

### A. Что видит пользователь
Ключевые метрики, кнопки запуска, ссылки в разделы.

### B. Элементы страницы
| Элемент | Тип | Когда виден | Что делает |
|---|---|---|---|
| Ключевое слово | Поле | Всегда | Задает поиск |
| Глубина/источник | Выбор | Всегда | Настраивает поиск |
| Запустить | Кнопка | Когда заполнено | Стартует процесс |

### C. Какие действия можно выполнить
Запустить поиск, перейти в нужный раздел.

### D. Сквозной процесс
1. Ввести параметры.
2. Нажать запуск.
3. Перейти в список запусков.

### E. Как работает СЕЙЧАС
Работает. Технические детали (по коду на 07.02.2026):
- **Блок «Доменов в очереди»:** кликабельная карточка → переход к `/domains?status=pending`. Значение: `stats.domains_in_queue` (SQL: `SELECT COUNT(*) FROM pending`). Подпись: «Ожидают извлечения данных».
- **Блок «Новые поставщики»:** значение `stats.new_suppliers` — за последние 24 часа.
- **Запуск парсинга:** форма с полями keyword, depth, source (google/yandex/both).
- **Файл:** `page-optimized.tsx` — использует React Query hooks `useModeratorStats`, `useParsingRuns`, `useParsingRun`, `useDomainsQueue`.

### F. Как ДОЛЖНО работать
Показывать только актуальные и точные цифры.

### G. Ограничения и ожидания
Ошибкой считается несоответствие цифр фактическим данным.

### H. Проверяемые утверждения
- ЕСЛИ запуск сделан, он должен появиться в истории.

## Страница: Запуски
URL: `/parsing-runs`

### Цель страницы
История запусков и вход в детали.

### Связанные процессы
Парсинг, удаление запусков.

### A. Что видит пользователь
Таблицу запусков с фильтрами.

### B. Элементы страницы
| Элемент | Тип | Когда виден | Что делает |
|---|---|---|---|
| Таблица | Таблица | Всегда | Показывает запуски |
| Фильтры | Фильтры | Всегда | Уточняют выдачу |
| Удаление | Кнопка | При выборе | Удаляет запуск |

### C. Какие действия можно выполнить
Открыть запуск, удалить запуск.

### D. Сквозной процесс
1. Найти запуск.
2. Открыть детали.
3. При необходимости удалить.

### E. Как работает СЕЙЧАС
Работает.

### F. Как ДОЛЖНО работать
Удаление не должно оставлять "хвостов" в других разделах.

### G. Ограничения и ожидания
Ошибкой считается "призрак" удаленного запуска в интерфейсе.

### H. Проверяемые утверждения
- ЕСЛИ запуск удален, он не должен больше отображаться.

## Страница: Детали запуска
URL: `/parsing-runs/[runId]`

### Цель страницы
Управление доменами конкретного запуска.

### Связанные процессы
Обогащение, blacklist, создание/обновление компаний.

### A. Что видит пользователь
Список доменов, статусы, прогресс, логи.

### B. Элементы страницы
| Элемент | Тип | Когда виден | Что делает |
|---|---|---|---|
| Таблица доменов | Таблица | Всегда | Показывает результат |
| Получить данные | Кнопка | При выборе | Запускает обогащение |
| Логи | Гармошка | Во время/после обработки | Показывает ход |
| В blacklist | Действие | Для домена | Исключает домен |

### C. Какие действия можно выполнить
Запустить обработку, менять статус доменов через действия.

### D. Сквозной процесс
1. Выбрать домены.
2. Нажать "Получить данные".
3. Смотреть прогресс и итог.

### E. Как работает СЕЙЧАС
Работает, но критичны точность статусов и счетчиков.

### F. Как ДОЛЖНО работать
Любой домен должен иметь понятный конечный статус.

### G. Ограничения и ожидания
Ошибкой считается найденный ИНН/email без смены статуса.

### H. Проверяемые утверждения
- ЕСЛИ данные найдены, домен должен перейти в "Поставщик/Реселлер".

## Страница: Домены в очереди
URL: `/domains`

### Цель страницы
Обрабатывать домены, которые еще не стали компаниями.

### Связанные процессы
Обогащение доменов, blacklist.

### A. Что видит пользователь
Список доменов и массовые действия.

### B. Элементы страницы
| Элемент | Тип | Когда виден | Что делает |
|---|---|---|---|
| Поиск | Поле | Всегда | Фильтрует |
| Выбор | Чекбоксы | При наличии строк | Формирует пакет |
| Получить данные | Кнопка | При выборе | Запускает обработку |

### C. Какие действия можно выполнить
Выбрать и обработать домены.

### D. Сквозной процесс
1. Отобрать домены.
2. Запустить обработку.
3. Проверить обновление.

### E. Как работает СЕЙЧАС
Работает.

### F. Как ДОЛЖНО работать
Не показывать blacklist-домены.

### G. Ограничения и ожидания
Ошибкой считается появление домена из черного списка.

### H. Проверяемые утверждения
- ЕСЛИ домен в blacklist, он не должен быть в очереди.

## Страница: Поставщики
URL: `/suppliers` и `/moderator/suppliers`

### Цель страницы
Управление базой компаний и полнотой данных.

### Связанные процессы
Редактирование компаний, получение данных Checko, создание поставщика вручную.

### A. Что видит пользователь
Таблицу компаний с пагинацией по 50, поиск, кнопку «Добавить поставщика».

### B. Элементы страницы
| Элемент | Тип | Когда виден | Что делает |
|---|---|---|---|
| Поиск | Поле ввода | Всегда | Фильтрует по имени/ИНН/домену (debounce 400ms) |
| Таблица | Таблица | Всегда | 50 записей на страницу, сортировка по столбцам |
| Строка поставщика | Кликабельная строка | Всегда | Переход в карточку `/suppliers/{id}` |
| Пагинация | Кнопки Назад/Вперёд | Всегда | Навигация по страницам |
| Добавить поставщика | Кнопка | Всегда | Переход на `/suppliers/new` |

### C. Какие действия можно выполнить
- Поиск поставщиков по имени, ИНН, домену.
- Клик по строке → переход в карточку предприятия.
- Создание нового поставщика вручную.
- Все действия (редактирование, просмотр, блеклист) — через карточку предприятия.

### D. Сквозной процесс
1. Найти поставщика через поиск.
2. Кликнуть по строке → открыть карточку.
3. В карточке: редактировать, просмотреть данные, добавить в блеклист.

### E. Как работает СЕЙЧАС
Технические детали (по коду на 07.02.2026):
- **Компонент таблицы:** `SuppliersTableVirtualized.tsx` (120 строк). Виртуализация убрана, скроллбар убран, меню «3 точки» убрано.
- **Клик по строке:** `onClick={() => router.push(/suppliers/${s.id})}` с `cursor-pointer`.
- **Пагинация:** `PAGE_SIZE = 50` в `suppliers-client.tsx`. Кнопки «Назад»/«Вперёд», отображение «Страница X из Y».
- **Поиск:** debounce 400ms через `useEffect` + `setTimeout`. `debouncedSearch` передаётся в API `getSuppliers({search: ...})`.
- **Suspense:** `page.tsx` обёрнут в `<Suspense>` для корректной работы `useSearchParams()` в Next.js 16.
- **Создание поставщика:** endpoint `POST /moderator/suppliers` в `moderator_suppliers.py`. Email-валидация: regex `r"^[^\s@]+@[^\s@]+\.[^\s@]+$"` (исправлен с двойного бэкслеша).

### F. Как ДОЛЖНО работать
Отчет должен быть всегда понятный и воспроизводимый.

### G. Ограничения и ожидания
Ошибкой считается отсутствие отчета после запуска.

### H. Проверяемые утверждения
- ЕСЛИ выбраны N компаний без данных, должен быть отчет по N.

## Страницы личного кабинета
URL: `/cabinet*`

### Цель страницы
Полный цикл работы пользователя с заявками и сообщениями.

### Связанные процессы
Создание заявки, подбор поставщиков, коммуникация.

### A. Что видит пользователь
Заявки, поставщиков по заявке, сообщения, настройки.

### B. Элементы страницы
| Элемент | Тип | Когда виден | Что делает |
|---|---|---|---|
| Форма заявки | Форма | При создании | Создает заявку |
| Список заявок | Список | Всегда | Открывает нужную заявку |
| Список поставщиков | Таблица | В заявке | Показывает результат |
| Сообщения | Список/форма | В разделе сообщений | Отправка и чтение |

### C. Какие действия можно выполнить
Создать заявку, отправить в работу, общаться с поставщиками.

### D. Сквозной процесс
1. Создать заявку.
2. Отправить в работу.
3. Дождаться результатов.
4. Отправить сообщения поставщикам.

### E. Как работает СЕЙЧАС
Основной сценарий работает.

### F. Как ДОЛЖНО работать
Пользователь должен видеть только свои данные и понятные статусы.

### G. Ограничения и ожидания
Ошибкой считается доступ к чужим данным.

### H. Проверяемые утверждения
- ЕСЛИ пользователь открыл свою заявку, он должен видеть связанные результаты и сообщения.

# Жизненные циклы сущностей
- Заявка: Черновик → Отправлена → В работе → Завершена.
- Компания: Создана → Данные не полные → Данные получены → Обновлена.
- Запуск парсинга: Создан → В работе → Завершен/Ошибка → (при необходимости) восстановлен.

# Связи сущностей и страниц
- Запуск парсинга:
  - `/moderator`
  - `/parsing-runs`
  - `/parsing-runs/[runId]`
- Компания:
  - `/suppliers`
  - `/suppliers/[id]`
  - `/suppliers/[id]/edit`
  - `/cabinet/requests/[id]` (как результат для пользователя)
- Заявка:
  - `/cabinet`
  - `/cabinet/requests/all`
  - `/cabinet/requests/drafts`
  - `/cabinet/requests/[id]`
- Черный список:
  - `/blacklist`
  - влияет на `/domains` и `/parsing-runs/[runId]`

# Типовые ошибки и действия пользователя
- Не тянутся данные компании:
  - проверить ИНН
  - проверить ключи Checko
  - повторить получение
- Домен не исчез после добавления в blacklist:
  - обновить страницу
  - проверить, что домен точно добавлен
- Статусы в запуске выглядят странно:
  - сверить прогресс и логи
  - проверить, не зависла ли обработка
- Компания найдена в логах, но не видна в таблице:
  - проверить конфликт ИНН
  - обновить список компаний

# Что система НЕ делает (Out of Scope)
- Не гарантирует 100% поиск ИНН/email на любом сайте.
- Не заменяет юридическую проверку компании человеком.
- Не дает доступ гостям к рабочим данным.
- НЕПРОВЕРЕНО: полный аудит всех действий пользователя в отдельном журнале.

# Критерии корректной работы системы
Система считается работающей правильно, если:
- Подняты все основные сервисы (frontend, backend, parser, CDP) — `B2BLauncher.exe` показывает 4/4 READY.
- Заявка создается и проходит путь до результата.
- Запуски отображаются с корректными статусами.
- Домен после обработки получает понятный итоговый статус.
- По найденному ИНН/email создается или обновляется компания.
- Данные Checko сохраняются и меняют статус на "получены".
- Домен из blacklist не появляется в рабочих списках.
- Массовое получение данных в поставщиках дает отчет "X из Y".
- Парсер не зацикливается на уже обработанных доменах (проверка full+root domain).
- Список ранов загружается быстро (batch query для domain counts).
- Поиск поставщиков работает с debounce, не перезагружает страницу.
- Создание поставщика вручную не даёт ошибку 422 на валидном email.

# Инфраструктура запуска

## B2BLauncher
**Файл:** `tools/b2b_launcher/b2b_launcher.py` → компилируется в `B2BLauncher.exe`

| Сервис | Порт | Как запускается | Health URL |
|---|---|---|---|
| PARSER | 9000 | `.venv_clean/Scripts/python.exe -u parser_service/run_api.py` | `http://127.0.0.1:9000/health` |
| BACKEND | 8000 | `.venv_clean/Scripts/python.exe -u backend/run_api.py` | `http://127.0.0.1:8000/health` |
| FRONTEND | 3000 | `npm run start -- -p 3000` (production build) | `http://localhost:3000/login` |
| CDP | 7000 | Chrome `--remote-debugging-port=7000` (реальный профиль) | `http://127.0.0.1:7000/json/version` |

- Python определяется через `_venv_python()`: `.venv_clean` → `.venv` → `venv` → `sys.executable`.
- CDP запускается **только после** того, как PARSER + BACKEND + FRONTEND в статусе READY.
- Автоматический перезапуск упавших сервисов с rate-limiting (max 8 перезапусков за 10 мин).
- Backend **не перезапускается** по health probe failures (только по exit code) — защита от restart storms при тяжёлых batch-операциях.

## Зависимости `.venv_clean`
Все Python-зависимости backend и parser должны быть установлены в `.venv_clean`. Список: `backend/requirements.txt`. Критичные: `slowapi`, `fastapi`, `uvicorn`, `sqlalchemy`, `asyncpg`.
