# B2B Platform Frontend (moderator-dashboard-ui) — описание страниц и доступов

Источник кода: `d:\b2b\frontend\moderator-dashboard-ui`

## Как устроен доступ

- Доступ контролируется компонентом `components/auth-guard.tsx`.
- Проверка выполняется через `GET /api/auth/status`.
- Если страница **только для модератора** (`allowedRoles={["moderator"]}`), то дополнительно проверяется `user.can_access_moderator`.
  - Если `can_access_moderator=false`, происходит редирект в `/cabinet`.
- Роль `admin` трактуется как «суперроль» (может проходить проверки по ролям), но **на практике** модераторские страницы чаще ограничены явно `allowedRoles={["moderator"]}`.

## Вход и редиректы

- **`/`**
  - **Что делает:** проверяет `/api/auth/status`.
  - **Если авторизован:**
    - `can_access_moderator=true` -> `/moderator`
    - иначе -> `/cabinet`
  - **Если не авторизован:** редирект на `/login`
  - **Доступ:** публичная страница-редирект.

- **`/login`**
  - **Что есть:** страница входа «Войти через Яндекс» (OAuth).
  - **Доступ:** публичная.

- **`/cabinet/login`**
  - **Что делает:** технический редирект на `/login?redirect=...`.
  - **Доступ:** публичная (но смысла без `/login` нет).

## Раздел: Модератор (moderator-only)

- **`/moderator`**
  - **Что есть:** дашборд модератора.
    - запуск парсинга по ключевому слову (keyword/depth/source)
    - виджеты статистики (очередь доменов, активные запуски, blacklist и т.д.)
    - прогресс бар парсинга + polling статуса
    - список последних запусков
  - **Доступ:** `moderator`.

- **`/moderator/tasks`**
  - **Что есть:** список «задач» модератора (заявка + запуски парсинга по ключам), статусы.
  - **Доступ:** `moderator`.

- **`/moderator/suppliers`**
  - **Что делает:** алиас/экспорт страницы `/suppliers`.
  - **Доступ:** `moderator` (наследуется от `/suppliers`).

- **`/moderator/users`**
  - **Что делает:** алиас/экспорт страницы `/users`.
  - **Доступ:** `moderator`/`admin` (наследуется от `/users`).

## Раздел: Запуски парсинга (moderator-only)

- **`/parsing-runs`**
  - **Что есть:** таблица запусков.
    - фильтр по статусу (all/running/completed/failed)
    - поиск по keyword
    - массовое удаление
    - переход в карточку запуска
  - **Доступ:** `moderator`.

- **`/parsing-runs/[runId]`**
  - **Что есть:** карточка конкретного запуска.
    - список найденных URL/доменов (группировка по доменам)
    - логи парсинга (Google/Yandex), прогресс
    - массовые действия по доменам
    - Domain Parser batch (обогащение доменов: ИНН/email) + polling
    - автосохранение доменов с ИНН+email в поставщиков, загрузка данных Checko
    - добавление домена в blacklist
    - обучение (manual learn INN)
  - **Доступ:** `moderator`.

## Раздел: Домены/ключи/blacklist (moderator-only)

- **`/domains`**
  - **Что есть:** «Домены в очереди» (pending domains).
    - поиск
    - выделение доменов
    - массовое «Получить данные» (enrich)
    - очистка списка
    - действия по строке: добавить в blacklist / создать поставщика
  - **Доступ:** `moderator`.

- **`/keywords`**
  - **Что есть:** управление ключевыми словами.
    - добавление/удаление ключей
    - разворачивание ключа -> связанные URL/домены
    - фильтрация и группировка по root-domain
    - исключение доменов из blacklist
  - **Доступ:** `moderator`.

- **`/blacklist`**
  - **Что есть:** управление чёрным списком доменов.
    - добавление домена + причина
    - таблица blacklist
    - удаление домена из blacklist
  - **Доступ:** `moderator`.

- **`/manual-parsing`**
  - **Что есть:** ручной запуск парсинга (keyword/depth/source), затем переход в `/parsing-runs/[runId]`.
  - **Доступ:** `moderator`.

## Раздел: Поставщики (moderator-only)

- **`/suppliers`**
  - **Что есть:** список/управление поставщиками (UI вынесен в `SuppliersClient`).
  - **Доступ:** `moderator`.

- **`/suppliers/new`**
  - **Что есть:** создание поставщика (через `SupplierEditClient supplierId={0}`).
  - **Доступ:** `moderator`.

- **`/suppliers/[id]`**
  - **Что есть:** карточка поставщика (`SupplierDetail`).
  - **Доступ:** `moderator`.

- **`/suppliers/[id]/edit`**
  - **Что есть:** редактирование поставщика (`SupplierEditClient`).
  - **Доступ:** `moderator`.

## Раздел: Пользователи (moderator/admin)

- **`/users`**
  - **Что есть:** управление пользователями.
    - список
    - поиск
    - создание пользователя
    - удаление пользователей
    - переключатель `cabinet_access_enabled` (доступ в ЛК)
  - **Доступ:** `moderator` и `admin`.

## Раздел: Настройки модератора (moderator-only)

- **`/settings`**
  - **Что есть:** ключи интеграций/параметры модерации.
    - OpenAI API key (ввод нового значения)
    - Groq API key (ввод нового значения)
  - **Доступ:** `moderator`.

## Раздел: Личный кабинет (user + moderator)

- **`/cabinet/overview`**
  - **Что есть:** обзор ЛК.
    - статистика заявок (в обработке / готово)
    - кнопка «Создать заявку» -> `/cabinet`
  - **Доступ:** `user` и `moderator`.

- **`/cabinet`**
  - **Что есть:** рабочий экран создания заявки.
    - вкладка «Поиск»: название, позиции (ключи), глубина, распознавание файла, сохранение черновика, отправка в работу
    - вкладка «Файлы»: загрузка позиций в заявку по ID
  - **Доступ:** `user` и `moderator`.

- **`/cabinet/requests`**
  - **Что делает:** редирект на `/cabinet/requests/all`.
  - **Доступ:** зависит от целевой страницы.

- **`/cabinet/requests/all`**
  - **Что есть:** список подтверждённых (submitted) заявок.
  - **Доступ:** `user` и `moderator`.

- **`/cabinet/requests/drafts`**
  - **Что есть:** список черновиков.
  - **Доступ:** `user` и `moderator`.

- **`/cabinet/requests/[id]`**
  - **Что есть:** карточка заявки.
    - позиции (ключи)
    - список поставщиков по заявке
    - выбор поставщиков + массовая отправка писем
    - просмотр переписки с поставщиком (dialog/thread)
    - polling списка поставщиков
  - **Доступ:** `user` и `moderator`.

- **`/cabinet/results`**
  - **Что есть:** агрегированный просмотр поставщиков по выбранной заявке + статусы коммуникаций.
  - **Доступ:** `user` и `moderator`.

- **`/cabinet/messages`**
  - **Что есть:** центр сообщений.
    - папки inbox/sent/spam/trash (если подключена Яндекс.Почта)
    - поиск/фильтр статусов
    - просмотр письма (text/html)
    - compose/reply
    - вложения через `/api/attachments` (upload)
    - fallback в demo-режим, если Яндекс OAuth не подключён
  - **Доступ:** `user` и `moderator`.

- **`/cabinet/settings`**
  - **Что есть:** настройки пользователя.
    - email, app-password
    - Groq API key
    - безопасность: 2FA статус, организация, смена пароля
  - **Доступ:** `user` и `moderator`.

## Технические страницы

- `app/robots.ts`, `app/sitemap.ts` — генерируемые robots/sitemap.

## Примечание по секретам

В репозитории есть файл `frontend/moderator-dashboard-ui/.env.local`, который содержит OAuth client secret и другие чувствительные значения. Для архива `fro2` я **исключу** `.env.local`.
