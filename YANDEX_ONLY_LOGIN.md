# Система входа только через Яндекс.Паспорт

## Статус конфигурации

✅ **Система полностью настроена на вход только через Яндекс.Паспорт**

### Удалено:
- ❌ Форма входа с логином/паролем
- ❌ Демо доступ (admin/admin123)
- ❌ Локальная аутентификация

### Добавлено:
- ✅ Единственный способ входа - Яндекс.Паспорт
- ✅ Автоматическая проверка конфигурации
- ✅ Статус-бары для мониторинга системы
- ✅ Приватная система с высокой безопасностью

## Текущие учетные данные Яндекса

Все необходимые переменные окружения уже установлены в `.env.local`:

```env
YANDEX_CLIENT_ID=f13aa94092e74191ab90ac908df3c42b
YANDEX_CLIENT_SECRET=170746997c17407bb388dd7872d2666a
YANDEX_REDIRECT_URI=http://localhost:3000/api/yandex/callback
YANDEX_SCOPE=login:email login:info mail:imap_full mail:smtp
```

## Как работает авторизация

### Процесс входа:

1. **Пользователь нажимает "Войти через Яндекс.Паспорт"**
   - Система проверяет конфигурацию Яндекса
   - Перенаправляет на страницу авторизации Яндекса

2. **Аутентификация в Яндексе**
   - Пользователь вводит логин и пароль от Яндекса
   - Яндекс запрашивает подтверждение предоставления прав

3. **Возврат в приложение**
   - Яндекс перенаправляет на `/api/yandex/callback` с кодом авторизации
   - Frontend обменивает код на access token
   - Frontend отправляет email на backend

4. **Регистрация/Авторизация в backend**
   - Backend проверяет email в системе
   - Если пользователя нет - создается новый аккаунт
   - Пользователю выдается JWT токен
   - JWT токен сохраняется в secure cookie `auth_token`

5. **Перенаправление**
   - Если email = `edwatik@yandex.ru` → `/moderator` (админ)
   - Для остальных пользователей → `/cabinet` (личный кабинет)

## Файлы системы авторизации

### Frontend:

1. **`app/login/page.tsx`**
   - Главная страница входа только через Яндекс
   - Проверка статуса backend и конфигурации
   - Обработка ошибок OAuth

2. **`app/api/yandex/login/route.ts`**
   - Инициирует OAuth процесс
   - Генерирует state для защиты от CSRF
   - Перенаправляет на Яндекс

3. **`app/api/yandex/callback/route.ts`**
   - Получает код авторизации от Яндекса
   - Обменивает код на access token
   - Получает email пользователя
   - Регистрирует/авторизует в backend
   - Устанавливает JWT cookie
   - Перенаправляет в кабинет

4. **`app/api/yandex/config/route.ts`**
   - Проверяет, настроен ли Яндекс OAuth
   - Используется для проверки на странице входа

### Backend (FastAPI):

1. **`/api/auth/yandex-oauth`** (POST)
   - Принимает email от frontend
   - Создает/обновляет пользователя в БД
   - Возвращает JWT токен

## Тестирование

### Предусловия:
- ✅ Backend запущен на ngrok (https://hobnailed-ballistically-jolie.ngrok-free.dev)
- ✅ Frontend запущен на http://localhost:3000
- ✅ Яндекс OAuth учетные данные в `.env.local`

### Процесс тестирования:

1. **Откройте http://localhost:3000/login**
   - Должна появиться страница с кнопкой "Войти через Яндекс.Паспорт"
   - Статус-бары должны показывать:
     - ✅ Backend подключен
     - ✅ Яндекс OAuth настроен

2. **Нажмите на кнопку "Войти через Яндекс.Паспорт"**
   - Вы перейдете на страницу входа Яндекса
   - Введите свой логин и пароль от Яндекса

3. **Подтвердите права доступа**
   - Яндекс попросит подтвердить предоставление прав приложению
   - Нажмите "Разрешить"

4. **Авторизация завершена**
   - Вы будете перенаправлены в личный кабинет
   - Если ваш email = `edwatik@yandex.ru` → перейдете в модератор-панель
   - Для остальных → перейдете в `/cabinet`

## Переменные окружения

### Обязательные:

```env
# Яндекс OAuth
YANDEX_CLIENT_ID=f13aa94092e74191ab90ac908df3c42b
YANDEX_CLIENT_SECRET=170746997c17407bb388dd7872d2666a
YANDEX_REDIRECT_URI=http://localhost:3000/api/yandex/callback
YANDEX_SCOPE=login:email login:info mail:imap_full mail:smtp

# Backend
NEXT_PUBLIC_API_URL=https://hobnailed-ballistically-jolie.ngrok-free.dev

# Администратор
MODERATOR_MASTER_EMAIL=edwatik@yandex.ru
```

## Безопасность

### Защита от атак:

1. **CSRF Protection**
   - Используется OAuth state параметр
   - State проверяется перед обменом кода

2. **Secure Cookies**
   - JWT токены хранятся в httpOnly cookies
   - Cookies отправляются только через HTTPS (в продакшене)
   - SameSite=lax для защиты от CSRF

3. **Validation**
   - Все параметры от пользователя валидируются
   - Email проверяется на корректность
   - Code от Яндекса проверяется перед использованием

## Возможные ошибки и решения

### Ошибка: "YANDEX_CLIENT_ID is not configured"
**Решение:** Проверьте, что в `.env.local` установлены все переменные Яндекса

### Ошибка: "Backend недоступен"
**Решение:** 
- Убедитесь, что backend запущен на ngrok
- Проверьте URL в `NEXT_PUBLIC_API_URL`
- Убедитесь, что ngrok туннель активен

### Ошибка: "Яндекс не настроен"
**Решение:** Перезагрузите страницу браузера (F5)

### Ошибка при обмене кода: "Invalid redirect_uri"
**Решение:** Убедитесь, что `YANDEX_REDIRECT_URI` совпадает с URI в приложении на OAuth.Yandex.ru

### Ошибка: "access_denied"
**Решение:** Вы отказали приложению в предоставлении прав. Попробуйте еще раз.

## Изменение адреса приложения

Если вы измените адрес приложения (например, с localhost на другой хост):

1. Обновите в `.env.local`:
   ```env
   YANDEX_REDIRECT_URI=http://your-new-host:3000/api/yandex/callback
   ```

2. Обновите в приложении на OAuth.Yandex.ru:
   - Перейдите на https://oauth.yandex.ru/client/YOUR_CLIENT_ID
   - Измените Redirect URI на новый адрес
   - Сохраните изменения

## Контакты и поддержка

Для вопросов о системе авторизации обратитесь к администратору:
- Email: edwatik@yandex.ru
- Это же email автоматически получает права администратора при входе

---

**Дата обновления:** 2026-02-07
**Версия:** 1.0 (Яндекс Only)
